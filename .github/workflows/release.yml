---
name: Release

on:
  push:
    tags:
      - 'v[0-9]+.*'

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # macOS builds (native)
          - os: macos-latest
            target: x86_64-apple-darwin
            use_cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            use_cross: false

          # Linux builds
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: true

          # Windows build
          - os: ubuntu-latest
            target: x86_64-pc-windows-gnu
            use_cross: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (if needed)
        if: matrix.use_cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Install MinGW (for Windows target)
        if: matrix.target == 'x86_64-pc-windows-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Build binary
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: Create archive
        id: archive
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          # Determine OS and arch names for archive
          case "${{ matrix.target }}" in
            x86_64-apple-darwin)
              OS="darwin"
              ARCH="amd64"
              EXT=""
              ARCHIVE_EXT="tar.gz"
              ;;
            aarch64-apple-darwin)
              OS="darwin"
              ARCH="arm64"
              EXT=""
              ARCHIVE_EXT="tar.gz"
              ;;
            x86_64-unknown-linux-gnu)
              OS="linux"
              ARCH="amd64"
              EXT=""
              ARCHIVE_EXT="tar.gz"
              ;;
            aarch64-unknown-linux-gnu)
              OS="linux"
              ARCH="arm64"
              EXT=""
              ARCHIVE_EXT="tar.gz"
              ;;
            x86_64-pc-windows-gnu)
              OS="windows"
              ARCH="amd64"
              EXT=".exe"
              ARCHIVE_EXT="zip"
              ;;
          esac

          ARCHIVE_NAME="jetta_${VERSION}_${OS}_${ARCH}"
          mkdir -p "dist/${ARCHIVE_NAME}"
          BIN="target/${{ matrix.target }}/release/jetta${EXT}"
          cp "${BIN}" "dist/${ARCHIVE_NAME}/"
          cp README.md "dist/${ARCHIVE_NAME}/"

          cd dist
          if [ "${ARCHIVE_EXT}" = "tar.gz" ]; then
            tar -czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          else
            zip -r "${ARCHIVE_NAME}.zip" "${ARCHIVE_NAME}"
          fi
          cd ..

          NAME="${ARCHIVE_NAME}.${ARCHIVE_EXT}"
          echo "archive_name=${NAME}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: dist/${{ steps.archive.outputs.archive_name }}
          if-no-files-found: error

  release:
    name: Create Release & Update Homebrew
    needs: build
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          mkdir -p dist
          PATTERN1="*.tar.gz"
          PATTERN2="*.zip"
          find artifacts -type f \( -name "${PATTERN1}" \
            -o -name "${PATTERN2}" \) -exec cp {} dist/ \;
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE="Release ${{ github.ref_name }}"
          URL="https://github.com/Sam-Lane/jetta"
          NOTES="See [CHANGELOG.md](${URL}/blob/main/CHANGELOG.md)"
          gh release create "${{ github.ref_name }}" \
            --title "${TITLE}" \
            --notes "${NOTES}" \
            dist/*

      - name: Install Rust (for GoReleaser)
        uses: dtolnay/rust-toolchain@stable

      - name: Update Homebrew tap
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          
          # Download and calculate SHA256 for macOS AMD64
          URL_AMD64="https://github.com/Sam-Lane/jetta/releases/download/v${VERSION}/jetta_${VERSION}_darwin_amd64.tar.gz"
          curl -sL "${URL_AMD64}" -o /tmp/jetta_darwin_amd64.tar.gz
          SHA256_AMD64=$(shasum -a 256 /tmp/jetta_darwin_amd64.tar.gz | awk '{print $1}')
          
          # Download and calculate SHA256 for macOS ARM64
          URL_ARM64="https://github.com/Sam-Lane/jetta/releases/download/v${VERSION}/jetta_${VERSION}_darwin_arm64.tar.gz"
          curl -sL "${URL_ARM64}" -o /tmp/jetta_darwin_arm64.tar.gz
          SHA256_ARM64=$(shasum -a 256 /tmp/jetta_darwin_arm64.tar.gz | awk '{print $1}')
          
          # Clone homebrew-tap repository with authentication
          git clone https://x-access-token:${GH_TOKEN}@github.com/Sam-Lane/homebrew-tap /tmp/homebrew-tap
          cd /tmp/homebrew-tap
          
          # Create Formula directory if it doesn't exist
          mkdir -p Formula

          # Create formula file with direct variable substitution
          cat > Formula/jetta.rb << EOFORMULA
          class Jetta < Formula
            desc "Fast JWT CLI tool for decoding and inspecting JSON Web Tokens"
            homepage "https://github.com/Sam-Lane/jetta"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.intel?
                url "${URL_AMD64}"
                sha256 "${SHA256_AMD64}"
              else
                url "${URL_ARM64}"
                sha256 "${SHA256_ARM64}"
              end
            end

            def install
              bin.install "jetta"
            end

            test do
              assert_match "Usage:", shell_output("\#{bin}/jetta --help")
            end
          end
          EOFORMULA
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/jetta.rb
          git commit -m "chore: update jetta formula to v${VERSION}"
          git push
